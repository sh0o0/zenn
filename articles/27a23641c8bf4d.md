---
title: 'ãŠå®¶k8sã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸ in 2024'
emoji: 'ğŸ”–'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['kubernetes', 'k8s', 'ãƒ©ã‚ºãƒ‘ã‚¤', 'RaspberryPi']
published: true
---

ã“ã‚“ã«ã¡ã¯ ğŸ˜€
æœ€è¿‘ãŠå®¶ã§ãƒ©ã‚ºãƒ‘ã‚¤ã‚’ä½¿ã£ã¦ k8s ã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸã®ã§ã€ãã®æ‰‹é †ã‚’æ®‹ãã†ã¨æ€ã„ã¾ã™ï¼ï¼ˆä½•ç•ªç…ã˜ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒ ğŸ™„ï¼‰
è©³ç´°ã¯çœãã¾ã™ã€‚å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’è¦‹ã¦ç†è§£ã—ãªãŒã‚‰ã®æ–¹ãŒå‹‰å¼·ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

[å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †](https://v1-30.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

## ç’°å¢ƒ

- Raspberry Pi 4 Model B
  - [ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚­ãƒƒãƒˆ](https://www.amazon.co.jp/-/en/gp/product/B08F83TRY9/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&th=1)ã‚’è²·ã„ã¾ã—ãŸ
- OS: Ubuntu 24.04 LTS
  - æœ€åˆã¯ Raspbian ã§ k8s ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã¿ã¾ã—ãŸãŒã€kubelet ã‚„ kubeadm ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‘¨ã‚Šã§ã¤ã¾ã¥ãæ–­å¿µã—ã¾ã—ãŸã€‚
- Kubernetes: v1.30
- Docker: v27.1.1

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å‰ã«

### ãƒ©ã‚ºãƒ‘ã‚¤ã®åˆæœŸè¨­å®š

è©³ç´°ã¯çœãã¾ã™ãŒä»¥ä¸‹ã‚’ã—ã¾ã™ã€‚

- SSH æ¥ç¶šè¨­å®š
- Wi-Fi è¨­å®š
- IP Address ã®å›ºå®š
- ãƒ›ã‚¹ãƒˆåã®å›ºå®š

### ãƒ•ã‚¡ã‚¤ã‚¢ãƒ¼ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®š & ãƒãƒ¼ãƒˆé–‹æ”¾

ssh ã§ä½¿ã† 22ã€k8s ã§ä½¿ã† 6443 ã‚’é–‹æ”¾ï¼

```sh
sudo apt install ufw
sudo ufw allow 22
sudo ufw allow 6443
sudo ufw enable
```

---

ãã®ä»–ã€ç§ã¯ã¨ãã«è¨­å®šã—ã¦ã„ã¾ã›ã‚“ãŒç’°å¢ƒæ¬¡ç¬¬ã§ç¢ºèªãƒ»è¨­å®šãŒå¿…è¦ãªã“ã¨ãŒã‚ã‚‹ã®ã§å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## container runtime ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### Docker ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †](https://docs.docker.com/engine/install/ubuntu/)

apt ã‚’è¨­å®š

```sh
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚ï¼‰

```sh
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

ãƒã‚§ãƒƒã‚¯ï¼

```sh
sudo docker run hello-world
```

### cgroup ã‚’ systemd ã«è¨­å®š

æ­£ç›´ cgroup ãŒä½•ãªã®ã‹ã‚ˆãåˆ†ã‹ã£ã¦ã¾ã›ã‚“ãŒä»¥ä¸‹ã®è¨­å®šã‚’ã—ã¾ã—ãŸã€‚

1. containerd config default > /etc/containerd/config.toml
2. /etc/containerd/config.toml ã‚’ç·¨é›†

```toml
 [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  ...
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
    SystemdCgroup = true â† ã“ã“
```

3. sudo systemctl restart containerd
4. /etc/default/kubele ã‚’ç·¨é›†

```toml
KUBELET_EXTRA_ARGS=--cgroup-driver=systemd
```

## kubeadm, kubelet, kubectl ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
sudo apt-get update

# apt-transport-https may be a dummy package; if so, you can skip that package
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

# If the directory `/etc/apt/keyrings` does not exist, it should be created before the curl command, read the note below.
sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# This overwrites any existing configuration in /etc/apt/sources.list.d/kubernetes.list
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

sudo systemctl enable --now kubelet
```

## Cluster ã‚’ä½œæˆ

ä»Šå›ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰ã« [flannel](https://github.com/flannel-io/flannel) ã‚’ä½¿ã„ã¾ã™ã€‚

1. sudo kubeadm init --apiserver-advertise-address=${FIXED_IP_ADDRESS} --pod-network-cidr=10.244.0.0/16
   - FIXED_IP_ADDRESS ã¯ãƒ©ã‚ºãƒ‘ã‚¤ã®å›ºå®šã—ãŸ IP Address
2. kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
3. kubectl taint nodes --all node-role.kubernetes.io/control-plane-
   - ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™

## æœ€å¾Œã«

è‡ªåˆ†ã®ãƒ¡ãƒ¢ç”¨ã«æ®‹ã—ã¦ã‚‚ã®ã‚’è¨˜äº‹åŒ–ã—ã¾ã—ãŸã€‚èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚
é–“é•ã„ã‚ã£ãŸã‚‰ã™ã„ã¾ã›ã‚“ ğŸ™‡
